CREATE OR REPLACE 
PACKAGE BODY    archives_manage_pg
AS
/******************************************************************************
   NAME:       ARCHIVES_MANAGE_PG
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        2013-12-07             1. Created this package body.
******************************************************************************/
   FUNCTION get_record (
      v_userid         IN   NUMBER,
      v_todo_type      IN   INTEGER,
      --0:????1:????2??????3??????????4??????????5:?????????? 6:????????????
      v_archive_type   IN   INTEGER,                     --0:????1:????2.????
      v_subject        IN   VARCHAR2,
      v_depname        IN   VARCHAR2,
      v_defid          IN   NUMBER,
      v_start_dt       IN   VARCHAR2,
      v_end_dt         IN   VARCHAR2,
      v_orgdepid       IN   VARCHAR2,
      v_archive_no     IN   VARCHAR2,
      v_snconfig_id    IN   NUMBER,
      v_depsign_no     IN   VARCHAR2,
      v_issuer_name    IN   VARCHAR2,
      v_issuedep_id    IN   NUMBER,
      v_querytype      IN   INTEGER                            --0:????1:????
   )
      RETURN todolist_table PIPELINED
   IS
      l_start_dt              DATE;
      l_end_dt                DATE;
      l_count                 INTEGER;
      l_pre_user_id           NUMBER;
      l_pre_user_name         VARCHAR2 (200 BYTE);
      l_pre_dep_id            NUMBER;
      l_pre_dep_name          VARCHAR2 (200 BYTE);
      l_assign_name           VARCHAR2 (200 BYTE);
      l_cur_dep_id            NUMBER;
      l_cur_depname           VARCHAR2 (200 BYTE);
      l_data_value            VARCHAR2 (200 BYTE);
      l_creator_dep_id        NUMBER;
      l_creator_dep_name      VARCHAR2 (200 BYTE);
      l_pre_activity_name     VARCHAR2 (200 BYTE);
      l_max_formid            NUMBER;
      l_is_admin              INTEGER             := 0;          --??????????
      l_is_common_admin       INTEGER             := 0;          --??????????
      l_is_officestaff        INTEGER             := 0;            --????????
      l_is_officestaffadmin   INTEGER             := 0;          --??????????
      l_is_superviseadmin     INTEGER             := 0;          --??????????
      l_depid                 NUMBER              := -1;
      l_roleid                NUMBER;
      l_querytype             INTEGER;
      l_row                   todolist_entity;
   BEGIN
      IF (v_start_dt IS NULL OR v_start_dt = '')
      THEN
         l_start_dt := TO_DATE ('1900-01-01', 'YYYY-MM-DD');
      ELSE
         l_start_dt := TO_DATE (v_start_dt, 'YYYY-MM-DD');
      END IF;

      l_querytype := v_querytype;

      IF (v_end_dt IS NULL OR v_end_dt = '')
      THEN
         l_end_dt := TRUNC (ADD_MONTHS (SYSDATE, 12) + 1);
      --TRUNC (SYSDATE + 1);
      ELSE
         l_end_dt := TRUNC (TO_DATE (v_end_dt, 'YYYY-MM-DD') + 1);
      END IF;

/*****************************????????????????????????????????????????????????******************************************/
      IF (v_querytype = 1)
      THEN
         SELECT COUNT (*)
           INTO l_count
           FROM user_role
          WHERE roleid = -1 AND userid = v_userid;

         IF (l_count > 0)
         THEN
            l_is_admin := 1;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'commonAdminId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'commonAdminId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_common_admin := 1;
            END IF;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'officeStaffRoleId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'officeStaffRoleId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_officestaff := 1;
            END IF;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'officeStaffAdminRoleId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'officeStaffAdminRoleId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_officestaffadmin := 1;
            END IF;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'superviseAdminRoleId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'superviseAdminRoleId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_superviseadmin := 1;
            END IF;
         END IF;
      END IF;

      IF (l_is_admin = 0)
      THEN
         SELECT depid
           INTO l_depid
           FROM app_user
          WHERE ROWNUM < 2 AND userid = v_userid;
      END IF;

      IF (    l_is_officestaff = 0
          AND l_is_officestaffadmin = 0
          AND l_is_admin = 0
          AND l_is_common_admin = 0
          AND l_is_superviseadmin = 0
         )                                --??????????????????????????????????
      THEN
         l_querytype := 0;
      END IF;

/***************************************????????*******************************************/
      IF (v_todo_type = 0)
      THEN
         l_querytype := 0;

         IF (l_querytype = 0)
         THEN
            FOR rc IN (SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                              JOIN pro_definition pd ON pr.defid = pd.defid
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                          AND jt.assignee_ = TO_CHAR (v_userid)
                       UNION
                       SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN pro_definition pd ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid = ar.process_ins_id
                              JOIN jbpm4_participation jp
                              ON jt.dbid_ = jp.task_
                            AND jt.assignee_ IS NULL
                            AND jp.type_ = 'candidate'
                            AND EXISTS (
                                   SELECT 1
                                     FROM user_role
                                    WHERE (   roleid IN (
                                                 SELECT     TRIM
                                                               (REGEXP_SUBSTR
                                                                   (jp.groupid_,
                                                                    '[^,]+',
                                                                    1,
                                                                    LEVEL
                                                                   )
                                                               ) aa
                                                       FROM DUAL
                                                 CONNECT BY LEVEL <=
                                                                 LENGTH
                                                                    (REGEXP_REPLACE
                                                                        (groupid_,
                                                                         '[^,]*'
                                                                        )
                                                                    )
                                                               + 1)
                                           OR (    jp.userid_ = userid
                                               AND jp.groupid_ IS NULL
                                              )
                                          )
                                      AND userid = v_userid)
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              ))
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.task_id := rc.dbid_;
               l_row.task_name := rc.name_;
               l_row.activityname := rc.activity_name_;
               l_row.run_subject := rc.subject;

               BEGIN
                  l_row.assign_user_id := TO_NUMBER (rc.assignee_);
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     l_row.assign_user_id := NULL;
               END;

               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.send_time := NULL;
               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;
               l_row.task_create_date := rc.create_;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.assign_user_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname, fullname
                    INTO l_cur_dep_id, l_cur_depname, l_assign_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.assign_user_id;
               END IF;

               l_row.cur_dep_id := l_cur_dep_id;
               l_row.cur_dep_name := l_cur_depname;
               l_row.assign_user_name := l_assign_name;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.issuer_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.issuer_id;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         ELSE
            FOR rc IN (SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                              JOIN pro_definition pd ON pr.defid = pd.defid
                              JOIN app_user au
                              ON jt.assignee_ = TO_CHAR (au.userid)
                            AND (   l_is_admin = 1
                                 OR l_is_common_admin = 1
                                 OR au.depid = l_depid
                                )
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                       UNION
                       SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN pro_definition pd ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid = ar.process_ins_id
                              JOIN jbpm4_participation jp
                              ON jt.dbid_ = jp.task_
                            AND jt.assignee_ IS NULL
                            AND jp.type_ = 'candidate'
                            AND EXISTS (
                                   SELECT 1
                                     FROM user_role
                                    WHERE (   roleid IN (
                                                 SELECT     TRIM
                                                               (REGEXP_SUBSTR
                                                                   (jp.groupid_,
                                                                    '[^,]+',
                                                                    1,
                                                                    LEVEL
                                                                   )
                                                               ) aa
                                                       FROM DUAL
                                                 CONNECT BY LEVEL <=
                                                                 LENGTH
                                                                    (REGEXP_REPLACE
                                                                        (groupid_,
                                                                         '[^,]*'
                                                                        )
                                                                    )
                                                               + 1)
                                           OR (    jp.userid_ = userid
                                               AND jp.groupid_ IS NULL
                                              )
                                          )
                                      AND userid IN (SELECT userid
                                                       FROM app_user
                                                      WHERE depid = l_depid))
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              ))
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.task_id := rc.dbid_;
               l_row.task_name := rc.name_;
               l_row.activityname := rc.activity_name_;
               l_row.run_subject := rc.subject;

               BEGIN
                  l_row.assign_user_id := TO_NUMBER (rc.assignee_);
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     l_row.assign_user_id := NULL;
               END;

               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.send_time := NULL;
               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;
               l_row.task_create_date := rc.create_;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.assign_user_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname, fullname
                    INTO l_cur_dep_id, l_cur_depname, l_assign_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.assign_user_id;
               END IF;

               l_row.cur_dep_id := l_cur_dep_id;
               l_row.cur_dep_name := l_cur_depname;
               l_row.assign_user_name := l_assign_name;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.issuer_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.issuer_id;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         END IF;
      END IF;

/***************************************??????????*******************************************/
      IF (v_todo_type = 1)
      THEN
         IF (l_querytype = 0)
         THEN
            FOR rc IN (SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN pro_definition pd ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                              JOIN jbpm4_participation jp
                              ON jt.dbid_ = jp.task_
                            AND jp.type_ = 'candidate'
                            AND EXISTS (
                                   SELECT 1
                                     FROM user_role
                                    WHERE (   roleid IN (
                                                 SELECT     TRIM
                                                               (REGEXP_SUBSTR
                                                                   (jp.groupid_,
                                                                    '[^,]+',
                                                                    1,
                                                                    LEVEL
                                                                   )
                                                               ) aa
                                                       FROM DUAL
                                                 CONNECT BY LEVEL <=
                                                                 LENGTH
                                                                    (REGEXP_REPLACE
                                                                        (groupid_,
                                                                         '[^,]*'
                                                                        )
                                                                    )
                                                               + 1)
                                           OR (    jp.userid_ = userid
                                               AND jp.groupid_ IS NULL
                                              )
                                          )
                                      AND userid = v_userid)
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND NOT EXISTS (
                                 SELECT 1
                                   FROM process_form
                                  WHERE runid = pr.runid
                                    AND creatorid = v_userid)
                          AND jt.assignee_ <> TO_CHAR (v_userid)
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                       UNION
                       SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                              jt.activity_name_, pr.subject, jt.assignee_,
                              ar.archivesid, ar.issuerid, ar.issuer,
                              ar.createtime, ar.archivesno, ar.orgdep_name,
                              ar.issuedep, pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format, jt.create_
                         FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                              JOIN pro_definition pd ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid = ar.process_ins_id
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND jt.assignee_ <> TO_CHAR (v_userid)
                          AND EXISTS (
                                 SELECT 1
                                   FROM process_form
                                  WHERE runid = pr.runid
                                    AND creatorid = v_userid)
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              ))
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.task_id := rc.dbid_;
               l_row.task_name := rc.name_;
               l_row.activityname := rc.activity_name_;
               l_row.run_subject := rc.subject;

               BEGIN
                  l_row.assign_user_id := TO_NUMBER (rc.assignee_);
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     l_row.assign_user_id := NULL;
               END;

               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.send_time := NULL;
               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;

               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;
               l_row.task_create_date := rc.create_;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.assign_user_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname, fullname
                    INTO l_cur_dep_id, l_cur_depname, l_assign_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.assign_user_id;
               END IF;

               l_row.cur_dep_id := l_cur_dep_id;
               l_row.cur_dep_name := l_cur_depname;
               l_row.assign_user_name := l_assign_name;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.issuer_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.issuer_id;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         ELSE
            --??????????
            IF(l_is_admin = 1 OR l_is_common_admin = 1)
            THEN
            FOR rc IN
               (SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND pr.userid = v_userid
                UNION
                SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                       JOIN jbpm4_participation jp
                       ON jt.dbid_ = jp.task_
                     AND jp.type_ = 'candidate'
                     AND EXISTS (
                            SELECT 1
                              FROM user_role
                             WHERE (   roleid IN (
                                          SELECT     TRIM
                                                        (REGEXP_SUBSTR
                                                                 (jp.groupid_,
                                                                  '[^,]+',
                                                                  1,
                                                                  LEVEL
                                                                 )
                                                        ) aa
                                                FROM DUAL
                                          CONNECT BY LEVEL <=
                                                          LENGTH
                                                             (REGEXP_REPLACE
                                                                    (groupid_,
                                                                     '[^,]*'
                                                                    )
                                                             )
                                                        + 1)
                                    OR (    jp.userid_ = userid
                                        AND jp.groupid_ IS NULL
                                       )
                                   )
                               AND userid IN (SELECT userid
                                                FROM app_user
                                               WHERE depid = l_depid))
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND NOT EXISTS (
                               SELECT 1
                                 FROM process_form
                                WHERE runid = pr.runid
                                      AND creatorid = v_userid)
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                UNION
                SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       ))
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.task_id := rc.dbid_;
               l_row.task_name := rc.name_;
               l_row.activityname := rc.activity_name_;
               l_row.run_subject := rc.subject;

               BEGIN
                  l_row.assign_user_id := TO_NUMBER (rc.assignee_);
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     l_row.assign_user_id := NULL;
               END;

               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.send_time := NULL;
               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
              --DBMS_OUTPUT.put_line (rc.archivesid);
              --DBMS_OUTPUT.put_line (l_count);
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;
               l_row.task_create_date := rc.create_;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.assign_user_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname, fullname
                    INTO l_cur_dep_id, l_cur_depname, l_assign_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.assign_user_id;
               END IF;

               l_row.cur_dep_id := l_cur_dep_id;
               l_row.cur_dep_name := l_cur_depname;
               l_row.assign_user_name := l_assign_name;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.issuer_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.issuer_id;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
            ELSE
            --????????
            FOR rc IN
               (SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND pr.userid = v_userid
                UNION
                SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                       JOIN jbpm4_participation jp
                       ON jt.dbid_ = jp.task_
                     AND jp.type_ = 'candidate'
                     AND EXISTS (
                            SELECT 1
                              FROM user_role
                             WHERE (   roleid IN (
                                          SELECT     TRIM
                                                        (REGEXP_SUBSTR
                                                                 (jp.groupid_,
                                                                  '[^,]+',
                                                                  1,
                                                                  LEVEL
                                                                 )
                                                        ) aa
                                                FROM DUAL
                                          CONNECT BY LEVEL <=
                                                          LENGTH
                                                             (REGEXP_REPLACE
                                                                    (groupid_,
                                                                     '[^,]*'
                                                                    )
                                                             )
                                                        + 1)
                                    OR (    jp.userid_ = userid
                                        AND jp.groupid_ IS NULL
                                       )
                                   )
                               AND userid IN (SELECT userid
                                                FROM app_user
                                               WHERE depid = l_depid))
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND NOT EXISTS (
                               SELECT 1
                                 FROM process_form
                                WHERE runid = pr.runid
                                      AND creatorid = v_userid)
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                UNION
                SELECT pr.defid, pr.runid, jt.dbid_, jt.name_,
                       jt.activity_name_, pr.subject, jt.assignee_,
                       ar.archivesid, ar.issuerid, ar.issuer, ar.createtime,
                       ar.archivesno, ar.orgdep_name, ar.issuedep, pd.NAME,
                       pr.piid, ar.limited_date, ar.sign_date,
                       ar.content_format, jt.create_
                  FROM (
    SELECT jt1.dbid_ , jt1.name_ ,jt1.assignee_ , jt2.activity_name_ ,jt1.create_ ,jt1.EXECUTION_ID_ 
    FROM JBPM4_TASK jt1,JBPM4_TASK jt2
    WHERE JT1.SUPERTASK_=JT2.DBID_ 
    UNION 
    SELECT dbid_,name_,assignee_,activity_name_,create_,EXECUTION_ID_ 
    FROM JBPM4_TASK 
    WHERE SUPERTASK_ IS NULL AND ASSIGNEE_ IS NOT NULL
) jt JOIN 
(
    SELECT JE2.ID_ PRID,JE1.ID_ JTID 
    FROM JBPM4_EXECUTION JE1,JBPM4_EXECUTION JE2
    WHERE JE1.PARENT_=JE2.DBID_ AND JE1.PARENT_ IS NOT NULL 
    UNION 
    SELECT JE.ID_ PRID,JE.ID_ JTID 
    FROM JBPM4_EXECUTION JE
    WHERE  PARENT_ IS NULL 
) JE ON JE.JTID=JT.EXECUTION_ID_
JOIN process_run pr ON JE.PRID=pr.piid
                       JOIN pro_definition pd ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND jt.assignee_ <> TO_CHAR (v_userid)
                   AND EXISTS (
                              SELECT 1
                                FROM process_form
                               WHERE runid = pr.runid
                                 AND creatorid IN (SELECT userid
                                                     FROM app_user
                                                    WHERE depid = l_depid))
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       ))
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.task_id := rc.dbid_;
               l_row.task_name := rc.name_;
               l_row.activityname := rc.activity_name_;
               l_row.run_subject := rc.subject;

               BEGIN
                  l_row.assign_user_id := TO_NUMBER (rc.assignee_);
               EXCEPTION
                  WHEN OTHERS
                  THEN
                     l_row.assign_user_id := NULL;
               END;

               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.send_time := NULL;
               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;
               l_row.task_create_date := rc.create_;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.assign_user_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname, fullname
                    INTO l_cur_dep_id, l_cur_depname, l_assign_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.assign_user_id;
               END IF;

               l_row.cur_dep_id := l_cur_dep_id;
               l_row.cur_dep_name := l_cur_depname;
               l_row.assign_user_name := l_assign_name;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = l_row.issuer_id and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = l_row.issuer_id;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
            END IF;
         END IF;
      END IF;

/***************************************??????????*******************************************/
      IF (v_todo_type = 2)
      THEN
         IF (l_querytype = 0)
         THEN
            FOR rc IN (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                              ar.issuerid, ar.issuer, ar.createtime,
                              ar.archivesno, ar.orgdep_name, ar.issuedep,
                              pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format
                         FROM process_run pr JOIN pro_definition pd
                              ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND EXISTS (
                                 SELECT 1
                                   FROM process_form
                                  WHERE runid = pr.runid
                                    AND creatorid = v_userid)
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                          AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         ELSE
            FOR rc IN
               (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                       ar.issuerid, ar.issuer, ar.createtime, ar.archivesno,
                       ar.orgdep_name, ar.issuedep, pd.NAME, pr.piid,
                       ar.limited_date, ar.sign_date, ar.content_format
                  FROM process_run pr JOIN pro_definition pd
                       ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND (   (    ar.depsignno IS NOT NULL
                            AND ar.depsignno LIKE '%' || v_depsign_no || '%'
                           )
                        OR (ar.depsignno IS NULL AND v_depsign_no IS NULL)
                       )
                   AND (   (    ar.issuer IS NOT NULL
                            AND ar.issuer LIKE '%' || v_issuer_name || '%'
                           )
                        OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                       )
                   AND (   (    v_issuedep_id IS NOT NULL
                            AND ((SELECT depid
                                    FROM app_user
                                   WHERE userid = ar.issuerid) = v_issuedep_id
                                )
                           )
                        OR (v_issuedep_id IS NULL AND 1 = 1)
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   l_is_admin = 1
                        OR l_is_common_admin = 1
                        OR EXISTS (
                              SELECT 1
                                FROM process_form
                               WHERE runid = pr.runid
                                 AND creatorid IN (SELECT userid
                                                     FROM app_user
                                                    WHERE depid = l_depid))
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                   AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT to_number(nvl(arch_checker,0)) is_reply
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_reply := l_count;
               SELECT to_number(nvl(arch_printer,0)) is_end
                 INTO l_count
                 FROM archives 
                WHERE  ARCHIVESID=rc.archivesid;
               l_row.is_end := l_count;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         END IF;
      END IF;

/***************************************??????????*******************************************/
      IF (v_todo_type = 3)                                        --??????????
      THEN
         FOR rc IN (SELECT DISTINCT pr.defid, pr.runid, pr.subject,
                                    ar.archivesid, ar.issuerid, ar.issuer,
                                    ar.createtime, ar.archivesno,
                                    ar.orgdep_name, ar.issuedep, pd.NAME,
                                    pr.piid, ar.limited_date, ar.sign_date,
                                    ar.content_format
                               FROM process_run pr JOIN pro_definition pd
                                    ON pr.defid = pd.defid
                                    JOIN archives ar
                                    ON pr.runid = ar.process_ins_id
                                    JOIN archives_dep ad
                                    ON ad.archivesid = ar.archivesid
                                    JOIN app_user au ON ad.depid = au.depid
                              WHERE pr.defid = NVL (v_defid, pr.defid)
                                AND pr.createtime >= l_start_dt
                                AND pr.createtime < l_end_dt
                                AND pr.subject LIKE '%' || v_subject || '%'
                                AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                AND (   (    ar.sn_config_id IS NOT NULL
                                         AND ar.sn_config_id =
                                                NVL (v_snconfig_id,
                                                     ar.sn_config_id
                                                    )
                                        )
                                     OR (    ar.sn_config_id IS NULL
                                         AND v_snconfig_id IS NULL
                                        )
                                    )
                                AND (   (    ar.depsignno IS NOT NULL
                                         AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                        )
                                     OR (    ar.depsignno IS NULL
                                         AND v_depsign_no IS NULL
                                        )
                                    )
                                AND (   (    ar.issuer IS NOT NULL
                                         AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                        )
                                     OR (    ar.issuer IS NULL
                                         AND v_issuer_name IS NULL
                                        )
                                    )
                                AND (   (    v_issuedep_id IS NOT NULL
                                         AND ((SELECT depid
                                                 FROM app_user
                                                WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                             )
                                        )
                                     OR (v_issuedep_id IS NULL AND 1 = 1)
                                    )
                                AND ar.issuedep LIKE '%' || v_depname || '%'
                                AND (   (    ar.orgdep_id IS NOT NULL
                                         AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                        )
                                     OR (    ar.orgdep_id IS NULL
                                         AND v_orgdepid IS NULL
                                        )
                                    )
                                AND (   l_is_admin = 1
                                     OR l_is_common_admin = 1
                                     OR EXISTS (SELECT 1
                                                  FROM archives_dep ad JOIN app_user au
                                                       ON au.depid = ad.depid
                                                 WHERE au.userid = v_userid)
                                    )
                                AND au.userid = v_userid
                                AND (   (    v_archive_type = 1
                                         AND ar.archtype IN (1, 2)
                                        )
                                     OR (    v_archive_type <> 1
                                         AND ar.archtype = v_archive_type
                                        )
                                    )
                                AND (ar.is_electronic_doc = 1 OR ar.status = 3
                                    )
                                AND pr.runstatus <> 3)
         LOOP
            l_row.def_id := rc.defid;
            l_row.run_id := rc.runid;
            l_row.run_subject := rc.subject;
            l_row.archive_id := rc.archivesid;
            l_row.issuer_id := rc.issuerid;
            l_row.issuer := rc.issuer;
            l_row.arch_create_time := rc.createtime;
            l_row.archives_no := rc.archivesno;
            l_row.orgdep_name := rc.orgdep_name;
            l_row.issuedep := rc.issuedep;
            l_row.flow_name := rc.NAME;
            l_row.piid := rc.piid;
            l_row.limited_date := rc.limited_date;
            l_row.sign_date := rc.sign_date;
            l_row.content_format := rc.content_format;

            SELECT COUNT (*)
              INTO l_count
              FROM app_user
             WHERE userid = rc.issuerid and delflag=0;

            IF (l_count > 0)
            THEN
               SELECT b.depid, b.depname
                 INTO l_creator_dep_id, l_creator_dep_name
                 FROM app_user a JOIN department b ON a.depid = b.depid
                WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
            END IF;

            l_row.creator_dep_id := l_creator_dep_id;
            l_row.creator_dep_name := l_creator_dep_name;
            PIPE ROW (l_row);
         END LOOP;
      END IF;

/***************************************????????*******************************************/
      IF (v_todo_type = 4)
      THEN
         IF (l_querytype = 0)
         THEN
            FOR rc IN (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                              ar.issuerid, ar.issuer, ar.createtime,
                              ar.archivesno, ar.orgdep_name, ar.issuedep,
                              pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format
                         FROM process_run pr JOIN pro_definition pd
                              ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND EXISTS (
                                 SELECT 1
                                   FROM process_form
                                  WHERE runid = pr.runid
                                    AND activityname = '????'
                                    AND creatorid = v_userid)
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                          AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         ELSE
            FOR rc IN (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                              ar.issuerid, ar.issuer, ar.createtime,
                              ar.archivesno, ar.orgdep_name, ar.issuedep,
                              pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format
                         FROM process_run pr JOIN pro_definition pd
                              ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND (   (    ar.depsignno IS NOT NULL
                                   AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                                  )
                               OR (    ar.depsignno IS NULL
                                   AND v_depsign_no IS NULL
                                  )
                              )
                          AND (   (    ar.issuer IS NOT NULL
                                   AND ar.issuer LIKE
                                                   '%' || v_issuer_name || '%'
                                  )
                               OR (ar.issuer IS NULL AND v_issuer_name IS NULL
                                  )
                              )
                          AND (   (    v_issuedep_id IS NOT NULL
                                   AND ((SELECT depid
                                           FROM app_user
                                          WHERE userid = ar.issuerid) =
                                                                 v_issuedep_id
                                       )
                                  )
                               OR (v_issuedep_id IS NULL AND 1 = 1)
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND EXISTS (SELECT 1
                                        FROM process_form
                                       WHERE runid = pr.runid)
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                          AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         END IF;
      END IF;

/***************************************????????????*******************************************/
      IF (v_todo_type = 6)
      THEN
         IF (l_querytype = 0)
         THEN
            FOR rc IN (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                              ar.issuerid, ar.issuer, ar.createtime,
                              ar.archivesno, ar.orgdep_name, ar.issuedep,
                              pd.NAME, pr.piid, ar.limited_date,
                              ar.sign_date, ar.content_format
                         FROM process_run pr JOIN pro_definition pd
                              ON pr.defid = pd.defid
                              JOIN archives ar ON pr.runid =
                                                            ar.process_ins_id
                        WHERE pr.defid = NVL (v_defid, pr.defid)
                          AND pr.createtime >= l_start_dt
                          AND pr.createtime < l_end_dt
                          AND pr.subject LIKE '%' || v_subject || '%'
                          AND ar.archivesno LIKE '%' || v_archive_no || '%'
                          AND (   (    ar.sn_config_id IS NOT NULL
                                   AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                                  )
                               OR (    ar.sn_config_id IS NULL
                                   AND v_snconfig_id IS NULL
                                  )
                              )
                          AND ar.issuedep LIKE '%' || v_depname || '%'
                          AND (   (    ar.orgdep_id IS NOT NULL
                                   AND ar.orgdep_id LIKE
                                                      '%' || v_orgdepid || '%'
                                  )
                               OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL
                                  )
                              )
                          AND EXISTS (
                                 SELECT 1
                                   FROM process_form
                                  WHERE runid = pr.runid
                                    AND creatorid = v_userid)
                          AND EXISTS (SELECT 1
                                        FROM archives_dep
                                       WHERE archivesid = ar.archivesid)
                          AND (   (v_archive_type = 1
                                   AND ar.archtype IN (1, 2)
                                  )
                               OR (    v_archive_type <> 1
                                   AND ar.archtype = v_archive_type
                                  )
                              )
                          AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         ELSE
            FOR rc IN
               (SELECT pr.defid, pr.runid, pr.subject, ar.archivesid,
                       ar.issuerid, ar.issuer, ar.createtime, ar.archivesno,
                       ar.orgdep_name, ar.issuedep, pd.NAME, pr.piid,
                       ar.limited_date, ar.sign_date, ar.content_format
                  FROM process_run pr JOIN pro_definition pd
                       ON pr.defid = pd.defid
                       JOIN archives ar ON pr.runid = ar.process_ins_id
                 WHERE pr.defid = NVL (v_defid, pr.defid)
                   AND pr.createtime >= l_start_dt
                   AND pr.createtime < l_end_dt
                   AND pr.subject LIKE '%' || v_subject || '%'
                   AND ar.archivesno LIKE '%' || v_archive_no || '%'
                   AND (   (    ar.sn_config_id IS NOT NULL
                            AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                           )
                        OR (ar.sn_config_id IS NULL AND v_snconfig_id IS NULL
                           )
                       )
                   AND ar.issuedep LIKE '%' || v_depname || '%'
                   AND (   (    ar.orgdep_id IS NOT NULL
                            AND ar.orgdep_id LIKE '%' || v_orgdepid || '%'
                           )
                        OR (ar.orgdep_id IS NULL AND v_orgdepid IS NULL)
                       )
                   AND (   l_is_admin = 1
                        OR l_is_common_admin = 1
                        OR EXISTS (
                              SELECT 1
                                FROM process_form
                               WHERE runid = pr.runid
                                 AND creatorid IN (SELECT userid
                                                     FROM app_user
                                                    WHERE depid = l_depid))
                       )
                   AND (   l_is_admin = 1
                        OR l_is_common_admin = 1
                        OR EXISTS (SELECT 1
                                     FROM archives_dep
                                    WHERE archivesid = ar.archivesid)
                       )
                   AND (   (v_archive_type = 1 AND ar.archtype IN (1, 2))
                        OR (    v_archive_type <> 1
                            AND ar.archtype = v_archive_type
                           )
                       )
                   AND pr.runstatus = 2)
            LOOP
               l_row.def_id := rc.defid;
               l_row.run_id := rc.runid;
               l_row.run_subject := rc.subject;
               l_row.archive_id := rc.archivesid;
               l_row.issuer_id := rc.issuerid;
               l_row.issuer := rc.issuer;
               l_row.arch_create_time := rc.createtime;
               l_row.archives_no := rc.archivesno;
               l_row.orgdep_name := rc.orgdep_name;
               l_row.issuedep := rc.issuedep;
               l_row.flow_name := rc.NAME;
               l_row.piid := rc.piid;
               l_row.limited_date := rc.limited_date;
               l_row.sign_date := rc.sign_date;
               l_row.content_format := rc.content_format;

               SELECT COUNT (*)
                 INTO l_count
                 FROM app_user
                WHERE userid = rc.issuerid and delflag=0;

               IF (l_count > 0)
               THEN
                  SELECT b.depid, b.depname
                    INTO l_creator_dep_id, l_creator_dep_name
                    FROM app_user a JOIN department b ON a.depid = b.depid
                   WHERE ROWNUM < 2 AND a.userid = rc.issuerid;
               END IF;

               l_row.creator_dep_id := l_creator_dep_id;
               l_row.creator_dep_name := l_creator_dep_name;
               PIPE ROW (l_row);
            END LOOP;
         END IF;
      END IF;
   END;

   PROCEDURE get_flow_todolist_all (
      v_userid             IN       NUMBER,
      v_todo_type          IN       INTEGER,  --0:????1:????2??????3??????????
      v_archive_type       IN       INTEGER,              --0:????1:????2.????
      v_subject            IN       VARCHAR2,
      v_depname            IN       VARCHAR2,
      v_defid              IN       NUMBER,
      v_start_dt           IN       VARCHAR2,
      v_end_dt             IN       VARCHAR2,
      v_start_page         IN       INTEGER,
      v_page_size          IN       INTEGER,
      v_orgdepid           IN       VARCHAR2,
      v_archive_no         IN       VARCHAR2,
      v_snconfig_id        IN       NUMBER,
      v_depsign_no         IN       VARCHAR2,
      v_issuer_name        IN       VARCHAR2,
      v_issuedep_id        IN       NUMBER,
      v_assign_user_name   IN       VARCHAR2,
      v_count              OUT      INTEGER,
      v_cursor             OUT      sys_refcursor
   )
   IS
      l_count             INTEGER;
      l_var_count         INTEGER;
      l_roleid            NUMBER;
      l_start_index       INTEGER;
      l_end_index         INTEGER;
      l_is_not_page       INTEGER := 0;
      l_is_common_admin   INTEGER := 0;
   BEGIN
      IF (v_page_size IS NULL OR v_page_size = -1)
      THEN
         l_is_not_page := 1;
      ELSE
         l_start_index := NVL (v_start_page, 0);
         l_end_index := l_start_index + v_page_size;
      END IF;

      SELECT COUNT (*)
        INTO l_count
        FROM user_role
       WHERE (roleid = -1 or roleid=7944307) AND userid = v_userid;

      SELECT COUNT (*)
        INTO l_var_count
        FROM sys_config
       WHERE configkey = 'commonAdminId';

      IF (l_var_count > 0)
      THEN
         SELECT TO_NUMBER (datavalue)
           INTO l_roleid
           FROM sys_config
          WHERE configkey = 'commonAdminId';

         SELECT COUNT (*)
           INTO l_var_count
           FROM user_role
          WHERE roleid = l_roleid AND userid = v_userid;

         IF (l_var_count > 0)
         THEN
            l_is_common_admin := 1;
         END IF;
      END IF;

      IF (v_todo_type <> -1)
      THEN
         IF (v_todo_type <> 5)
         THEN
            IF (l_count > 0 OR l_is_common_admin = 1)
            THEN
               SELECT COUNT (*)
                 INTO v_count
                 FROM TABLE (get_record (v_userid,
                                         v_todo_type,
                                         v_archive_type,
                                         v_subject,
                                         v_depname,
                                         v_defid,
                                         v_start_dt,
                                         v_end_dt,
                                         v_orgdepid,
                                         v_archive_no,
                                         v_snconfig_id,
                                         v_depsign_no,
                                         v_issuer_name,
                                         v_issuedep_id,
                                         1
                                        )
                            );
            ELSE
               SELECT COUNT (*)
                 INTO v_count
                 FROM TABLE (get_record (v_userid,
                                         v_todo_type,
                                         v_archive_type,
                                         v_subject,
                                         v_depname,
                                         v_defid,
                                         v_start_dt,
                                         v_end_dt,
                                         v_orgdepid,
                                         v_archive_no,
                                         v_snconfig_id,
                                         v_depsign_no,
                                         v_issuer_name,
                                         v_issuedep_id,
                                         0
                                        )
                            );
            END IF;
         ELSE
            SELECT COUNT (*)
              INTO v_count
              FROM (SELECT a.*
                      FROM TABLE (get_record (v_userid,
                                              0,
                                              v_archive_type,
                                              v_subject,
                                              v_depname,
                                              v_defid,
                                              v_start_dt,
                                              v_end_dt,
                                              v_orgdepid,
                                              v_archive_no,
                                              v_snconfig_id,
                                              v_depsign_no,
                                              v_issuer_name,
                                              v_issuedep_id,
                                              1
                                             )
                                 ) a
                    UNION
                    SELECT a.*
                      FROM TABLE (get_record (v_userid,
                                              1,
                                              v_archive_type,
                                              v_subject,
                                              v_depname,
                                              v_defid,
                                              v_start_dt,
                                              v_end_dt,
                                              v_orgdepid,
                                              v_archive_no,
                                              v_snconfig_id,
                                              v_depsign_no,
                                              v_issuer_name,
                                              v_issuedep_id,
                                              1
                                             )
                                 ) a) a
             WHERE a.assign_user_name LIKE '%' || v_assign_user_name || '%';
         END IF;
      ELSE
         SELECT COUNT (*)
           INTO v_count
           FROM (
SELECT MIN(def_id)   def_id,
      run_id, 
      MIN(task_id)  task_id  ,
      MIN(task_name) task_name,
      MIN(activityname) activityname,  
      run_subject ,  
      MIN(assign_user_id) assign_user_id,
      MIN(assign_user_name) assign_user_name,  
      MIN(archive_id) archive_id,    
      MIN(issuer_id) issuer_id,   
      MIN(issuer) issuer,     
      MIN(arch_create_time) arch_create_time,  
      MIN(send_time) send_time,     
      MIN(is_reply) is_reply,   
      MIN(is_end) is_end,         
      MIN(archives_no) archives_no,     
      MIN(orgdep_name) orgdep_name,     
      MIN(issuedep) issuedep,       
      MIN(cur_dep_id) cur_dep_id,     
      MIN(cur_dep_name) cur_dep_name,     
      MIN(flow_name) flow_name,        
      MIN(creator_dep_name) creator_dep_name,   
      MIN(creator_dep_id) creator_dep_id,   
      MIN(piid) piid,            
      MIN(limited_date) limited_date,   
      MIN(sign_date) sign_date,       
      MIN(content_format) content_format,   
      MIN(task_create_date)  task_create_date
FROM(
SELECT a.*
                   FROM TABLE (get_record (v_userid,
                                           0,
                                           v_archive_type,
                                           v_subject,
                                           v_depname,
                                           v_defid,
                                           v_start_dt,
                                           v_end_dt,
                                           v_orgdepid,
                                           v_archive_no,
                                           v_snconfig_id,
                                           v_depsign_no,
                                           v_issuer_name,
                                           v_issuedep_id,
                                           1
                                          )
                              ) a
                 UNION
                 SELECT a.*
                   FROM TABLE (get_record (v_userid,
                                           1,
                                           v_archive_type,
                                           v_subject,
                                           v_depname,
                                           v_defid,
                                           v_start_dt,
                                           v_end_dt,
                                           v_orgdepid,
                                           v_archive_no,
                                           v_snconfig_id,
                                           v_depsign_no,
                                           v_issuer_name,
                                           v_issuedep_id,
                                           1
                                          )
                              ) a
                 UNION
                 SELECT a.*
                   FROM TABLE (get_record (v_userid,
                                           2,
                                           v_archive_type,
                                           v_subject,
                                           v_depname,
                                           v_defid,
                                           v_start_dt,
                                           v_end_dt,
                                           v_orgdepid,
                                           v_archive_no,
                                           v_snconfig_id,
                                           v_depsign_no,
                                           v_issuer_name,
                                           v_issuedep_id,
                                           1
                                          )
                              ) a
) a GROUP BY run_id,run_subject
) a;
      --WHERE a.assign_user_name LIKE '%' || v_assign_user_name || '%';
      END IF;

      IF (l_is_not_page = 0)
      THEN
         IF (v_todo_type <> -1 AND v_todo_type <> 5)
         THEN
            IF (l_count > 0 OR l_is_common_admin = 1)
            THEN
               OPEN v_cursor FOR
                  SELECT m.*,
                         DECODE (v_todo_type,
                                 2, NULL,
                                 get_pre_task (m.run_id,m.task_id)
                                ) AS pre_task,
                         v_todo_type AS status
                    FROM (SELECT a.*, ROWNUM row_num
                            FROM (SELECT   a.*
                                      FROM TABLE (get_record (v_userid,
                                                              v_todo_type,
                                                              v_archive_type,
                                                              v_subject,
                                                              v_depname,
                                                              v_defid,
                                                              v_start_dt,
                                                              v_end_dt,
                                                              v_orgdepid,
                                                              v_archive_no,
                                                              v_snconfig_id,
                                                              v_depsign_no,
                                                              v_issuer_name,
                                                              v_issuedep_id,
                                                              1
                                                             )
                                                 ) a
                                  ORDER BY a.arch_create_time DESC) a) m
                   WHERE m.row_num > l_start_index
                         AND m.row_num <= l_end_index;
            ELSE
               OPEN v_cursor FOR
                  SELECT   m.*,
                           DECODE (v_todo_type,
                                   2, NULL,
                                   get_pre_task (m.run_id,m.task_id)
                                  ) AS pre_task,
                           v_todo_type AS status
                      FROM (SELECT   a.*, ROWNUM row_num
                                FROM (SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               v_todo_type,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id, 
                                                               0
                                                              )
                                                  ) a ORDER BY a.arch_create_time DESC ) a
                            ) m
                     WHERE m.row_num > l_start_index
                       AND m.row_num <= l_end_index;
            END IF;
         END IF;

         IF (v_todo_type = -1)
         THEN
            OPEN v_cursor FOR
               SELECT   m.*,
                        DECODE (status,
                                2, NULL,
                                get_pre_task (m.run_id,m.task_id)
                               ) AS pre_task
                   FROM (SELECT   b.*, ROWNUM row_num
                             FROM (SELECT   a.*,
                                            CASE
                                               WHEN a.task_id IS NULL
                                               AND a.assign_user_id IS NULL
                                                  THEN 2
                                               WHEN a.task_id IS NOT NULL
                                               AND a.assign_user_id <>
                                                                      v_userid
                                                  THEN 1
                                               ELSE 0
                                            END AS status
                                       FROM (
SELECT MIN(def_id)   def_id,
      run_id, 
      MIN(task_id)  task_id  ,
      MIN(task_name) task_name,
      MIN(activityname) activityname,  
      run_subject ,  
      MIN(assign_user_id) assign_user_id,
      MIN(assign_user_name) assign_user_name,  
      MIN(archive_id) archive_id,    
      MIN(issuer_id) issuer_id,   
      MIN(issuer) issuer,     
      MIN(arch_create_time) arch_create_time,  
      MIN(send_time) send_time,     
      MIN(is_reply) is_reply,   
      MIN(is_end) is_end,         
      MIN(archives_no) archives_no,     
      MIN(orgdep_name) orgdep_name,     
      MIN(issuedep) issuedep,       
      MIN(cur_dep_id) cur_dep_id,     
      MIN(cur_dep_name) cur_dep_name,     
      MIN(flow_name) flow_name,        
      MIN(creator_dep_name) creator_dep_name,   
      MIN(creator_dep_id) creator_dep_id,   
      MIN(piid) piid,            
      MIN(limited_date) limited_date,   
      MIN(sign_date) sign_date,       
      MIN(content_format) content_format,   
      MIN(task_create_date)  task_create_date
FROM(
SELECT a.*
                                               FROM TABLE
                                                       (get_record
                                                              (v_userid,
                                                               0,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                       ) a
                                             UNION
                                             SELECT a.*
                                               FROM TABLE
                                                       (get_record
                                                              (v_userid,
                                                               1,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                       ) a
                                             UNION
                                             SELECT a.*
                                               FROM TABLE
                                                       (get_record
                                                              (v_userid,
                                                               2,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                       ) a
) a GROUP BY run_id,run_subject
) a
                                   ORDER BY
                                   -- a.is_reply DESC,a.is_end ASC,
                                    a.arch_create_time DESC) b
                        ) m
                  WHERE m.row_num > l_start_index AND m.row_num <= l_end_index;
         END IF;

         IF (v_todo_type = 5)
         THEN
            OPEN v_cursor FOR
               SELECT   m.*,
                        DECODE (status,
                                2, NULL,
                                get_pre_task (m.run_id,m.task_id)
                               ) AS pre_task
                   FROM (SELECT   b.*, ROWNUM row_num,
                                  CASE
                                     WHEN b.task_id IS NULL
                                     AND b.assign_user_id IS NULL
                                        THEN 2
                                     WHEN b.task_id IS NOT NULL
                                     AND b.assign_user_id <> v_userid
                                        THEN 1
                                     ELSE 0
                                  END AS status
                             FROM (SELECT   *
                                       FROM (SELECT a.*
                                               FROM TABLE
                                                       (get_record
                                                              (v_userid,
                                                               0,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                       ) a
                                             UNION
                                             SELECT a.*
                                               FROM TABLE
                                                       (get_record
                                                              (v_userid,
                                                               1,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                       ) a) c
                                   ORDER BY c.task_create_date DESC) b
                            WHERE b.assign_user_name LIKE
                                              '%' || v_assign_user_name || '%'
                         ORDER BY b.task_create_date DESC) m
                  WHERE m.row_num > l_start_index AND m.row_num <= l_end_index
               ORDER BY m.task_create_date DESC;
         END IF;
      ELSE
         IF (v_todo_type <> -1 AND v_todo_type <> 5)
         THEN
            IF (l_count > 0 OR l_is_common_admin = 1)
            THEN
               OPEN v_cursor FOR
                  SELECT a.*,
                         DECODE (v_todo_type,
                                 2, NULL,
                                 get_pre_task (a.run_id,a.task_id)
                                ) AS pre_task,
                         v_todo_type AS status
                    FROM TABLE (get_record (v_userid,
                                            v_todo_type,
                                            v_archive_type,
                                            v_subject,
                                            v_depname,
                                            v_defid,
                                            v_start_dt,
                                            v_end_dt,
                                            v_orgdepid,
                                            v_archive_no,
                                            v_snconfig_id,
                                            v_depsign_no,
                                            v_issuer_name,
                                            v_issuedep_id,
                                            1
                                           )
                               ) a;
            ELSE
               OPEN v_cursor FOR
                  SELECT a.*,
                         DECODE (v_todo_type,
                                 2, NULL,
                                 get_pre_task (a.run_id,a.task_id)
                                ) AS pre_task,
                         v_todo_type AS status
                    FROM TABLE (get_record (v_userid,
                                            v_todo_type,
                                            v_archive_type,
                                            v_subject,
                                            v_depname,
                                            v_defid,
                                            v_start_dt,
                                            v_end_dt,
                                            v_orgdepid,
                                            v_archive_no,
                                            v_snconfig_id,
                                            v_depsign_no,
                                            v_issuer_name,
                                            v_issuedep_id,
                                            0
                                           )
                               ) a;
            END IF;
         ELSE
            IF (v_todo_type = 5)
            THEN
               OPEN v_cursor FOR
                  SELECT   m.*,
                           DECODE (status,
                                   2, NULL,
                                   get_pre_task (m.run_id,m.task_id)
                                  ) AS pre_task
                      FROM (SELECT   b.*, ROWNUM row_num,
                                     CASE
                                        WHEN b.task_id IS NULL
                                        AND b.assign_user_id IS NULL
                                           THEN 2
                                        WHEN b.task_id IS NOT NULL
                                        AND b.assign_user_id <> v_userid
                                           THEN 1
                                        ELSE 0
                                     END AS status
                                FROM (SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               0,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                  ) a
                                      UNION
                                      SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               1,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                  ) a) b
                               WHERE b.assign_user_name LIKE
                                              '%' || v_assign_user_name || '%'
                            ORDER BY b.task_create_date DESC) m
                  ORDER BY m.task_create_date DESC;
            ELSE
               OPEN v_cursor FOR
                  SELECT   m.*,
                           DECODE (status,
                                   2, NULL,
                                   get_pre_task (m.run_id,m.task_id)
                                  ) AS pre_task
                      FROM (SELECT   a.*, ROWNUM row_num,
                                     CASE
                                        WHEN a.task_id IS NULL
                                        AND a.assign_user_id IS NULL
                                           THEN 2
                                        WHEN a.task_id IS NOT NULL
                                        AND a.assign_user_id <> v_userid
                                           THEN 1
                                        ELSE 0
                                     END AS status
                                FROM (
SELECT MIN(def_id)   def_id,
      run_id, 
      MIN(task_id)  task_id  ,
      MIN(task_name) task_name,
      MIN(activityname) activityname,  
      run_subject ,  
      MIN(assign_user_id) assign_user_id,
      MIN(assign_user_name) assign_user_name,  
      MIN(archive_id) archive_id,    
      MIN(issuer_id) issuer_id,   
      MIN(issuer) issuer,     
      MIN(arch_create_time) arch_create_time,  
      MIN(send_time) send_time,     
      MIN(is_reply) is_reply,   
      MIN(is_end) is_end,         
      MIN(archives_no) archives_no,     
      MIN(orgdep_name) orgdep_name,     
      MIN(issuedep) issuedep,       
      MIN(cur_dep_id) cur_dep_id,     
      MIN(cur_dep_name) cur_dep_name,     
      MIN(flow_name) flow_name,        
      MIN(creator_dep_name) creator_dep_name,   
      MIN(creator_dep_id) creator_dep_id,   
      MIN(piid) piid,            
      MIN(limited_date) limited_date,   
      MIN(sign_date) sign_date,       
      MIN(content_format) content_format,   
      MIN(task_create_date)  task_create_date
FROM(
SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               0,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                  ) a
                                      UNION
                                      SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               1,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                  ) a
                                      UNION
                                      SELECT a.*
                                        FROM TABLE
                                                  (get_record (v_userid,
                                                               2,
                                                               v_archive_type,
                                                               v_subject,
                                                               v_depname,
                                                               v_defid,
                                                               v_start_dt,
                                                               v_end_dt,
                                                               v_orgdepid,
                                                               v_archive_no,
                                                               v_snconfig_id,
                                                               v_depsign_no,
                                                               v_issuer_name,
                                                               v_issuedep_id,
                                                               1
                                                              )
                                                  ) a
) a GROUP BY run_id,run_subject
) a
                            ORDER BY a.arch_create_time DESC) m
                  ORDER BY m.arch_create_time DESC;
            END IF;
         END IF;
      END IF;
   END;

   PROCEDURE get_archives_library (
      v_archive_type   IN       INTEGER,
      v_subject        IN       VARCHAR2,
      v_userid         IN       NUMBER,
      v_defid          IN       NUMBER,
      v_issuedep       IN       VARCHAR2,
      v_orgdep_id      IN       VARCHAR2,
      v_start_dt       IN       VARCHAR2,
      v_end_dt         IN       VARCHAR2,
      v_archive_no     IN       VARCHAR2,
      v_privacylevel   IN       VARCHAR2,
      v_urgentlevel    IN       VARCHAR2,
      v_snconfig_id    IN       NUMBER,
      v_depsign_no     IN       VARCHAR2,
      v_issuer_name    IN       VARCHAR2,
      v_start_page     IN       INTEGER,
      v_page_size      IN       INTEGER,
      v_count          OUT      INTEGER,
      v_cursor         OUT      sys_refcursor,
      v_asc_desc       IN       VARCHAR2,                      --0:????,1:????
      v_search         IN       VARCHAR2
   --0:????,1:????????,2:????????,3:????????
   )
   IS
      l_start_dt              DATE;
      l_end_dt                DATE;
      l_start_index           INTEGER;
      l_end_index             INTEGER;
      l_count                 INTEGER;
      l_is_not_page           INTEGER := 0;
      l_is_admin              INTEGER := 0;
      l_is_officestaff        INTEGER := 0;
      l_is_officestaffadmin   INTEGER := 0;
      l_is_common_admin       INTEGER := 0;
      l_depid                 NUMBER;
      l_roleid                NUMBER;
   BEGIN
      IF (v_start_dt IS NULL OR v_start_dt = '')
      THEN
         l_start_dt := TO_DATE ('1900-01-01', 'YYYY-MM-DD');
      ELSE
         l_start_dt := TO_DATE (v_start_dt, 'YYYY-MM-DD');
      END IF;

      IF (v_end_dt IS NULL OR v_end_dt = '')
      THEN
         l_end_dt := TRUNC (ADD_MONTHS (SYSDATE, 12) + 1);
      --TRUNC (SYSDATE + 1);
      ELSE
         l_end_dt := TRUNC (TO_DATE (v_end_dt, 'YYYY-MM-DD') + 1);
      END IF;

      IF (v_page_size IS NULL OR v_page_size = -1)
      THEN
         l_is_not_page := 1;
      ELSE
         l_start_index := NVL (v_start_page, 0);
         l_end_index := l_start_index + v_page_size;
      END IF;

      SELECT COUNT (*)
        INTO l_count
        FROM user_role
       WHERE (roleid = -1 or roleid=7944307) AND userid = v_userid;

      IF (l_count > 0)
      THEN
         l_is_admin := 1;
      ELSE
         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'officeStaffRoleId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'officeStaffRoleId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_officestaff := 1;
            END IF;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'commonAdminId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'commonAdminId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_common_admin := 1;
            END IF;
         END IF;

         SELECT COUNT (*)
           INTO l_count
           FROM sys_config
          WHERE configkey = 'officeStaffAdminRoleId';

         IF (l_count > 0)
         THEN
            SELECT TO_NUMBER (datavalue)
              INTO l_roleid
              FROM sys_config
             WHERE configkey = 'officeStaffAdminRoleId';

            SELECT COUNT (*)
              INTO l_count
              FROM user_role
             WHERE roleid = l_roleid AND userid = v_userid;

            IF (l_count > 0)
            THEN
               l_is_officestaffadmin := 1;
            END IF;
         END IF;
      END IF;

      IF (l_is_admin = 0)
      THEN
         SELECT depid
           INTO l_depid
           FROM app_user
          WHERE ROWNUM < 2 AND userid = v_userid;
      END IF;

      IF (v_archive_type = 0)
      THEN
         IF (    l_is_officestaff = 0
             AND l_is_officestaffadmin = 0
             AND l_is_admin = 0
             AND l_is_common_admin = 0
            )
         THEN
            SELECT COUNT (*)
              INTO v_count
              FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                           JOIN app_user au
                           ON ar.issuerid = au.userid
                         AND au.depid =
                                DECODE (v_orgdep_id,
                                        NULL, au.depid,
                                        TO_NUMBER (v_orgdep_id)
                                       )
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND EXISTS (
                               SELECT 1
                                 FROM process_form
                                WHERE runid = pr.runid
                                      AND creatorid = v_userid)
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2
                    UNION
                    SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                           JOIN app_user au
                           ON ar.issuerid = au.userid
                         AND au.depid =
                                DECODE (v_orgdep_id,
                                        NULL, au.depid,
                                        TO_NUMBER (v_orgdep_id)
                                       )
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.is_shared = 1
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2);
         ELSE
            SELECT COUNT (*)
              INTO v_count
              FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                           JOIN process_form pf ON pf.runid=pr.runid
                           JOIN app_user us ON pf.creatorid=us.userid
                           JOIN app_user au
                           ON ar.issuerid = au.userid
                         AND au.depid =
                                DECODE (v_orgdep_id,
                                        NULL, au.depid,
                                        TO_NUMBER (v_orgdep_id)
                                       )
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND (   l_is_admin = 1
                            OR l_is_common_admin = 1
                            OR us.depid = l_depid
                           )
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2
                    UNION
                    SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                           JOIN app_user au
                           ON ar.issuerid = au.userid
                         AND au.depid =
                                DECODE (v_orgdep_id,
                                        NULL, au.depid,
                                        TO_NUMBER (v_orgdep_id)
                                       )
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.is_shared = 1
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2);
         END IF;

         IF (l_is_not_page = 1)
         THEN
            IF (    l_is_officestaff = 0
                AND l_is_officestaffadmin = 0
                AND l_is_admin = 0
                AND l_is_common_admin = 0
               )
            THEN
               OPEN v_cursor FOR
                  SELECT   b.*,
                           DECODE (v_asc_desc,
                                   'ASC', 1000000 - ROWNUM,
                                   1000000 + ROWNUM
                                  ) AS row_count
                      FROM (SELECT   *
                                FROM (SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                             JOIN app_user au
                                             ON ar.issuerid = au.userid
                                           AND au.depid =
                                                  DECODE
                                                       (v_orgdep_id,
                                                        NULL, au.depid,
                                                        TO_NUMBER (v_orgdep_id)
                                                       )
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                                         AND ar.urgentlevel LIKE
                                                   '%' || v_urgentlevel || '%'
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND EXISTS (
                                                SELECT 1
                                                  FROM process_form
                                                 WHERE runid = pr.runid
                                                   AND creatorid = v_userid)
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND archtype = v_archive_type
                                         AND pr.runstatus = 2
                                      UNION
                                      SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                             JOIN app_user au
                                             ON ar.issuerid = au.userid
                                           AND au.depid =
                                                  DECODE
                                                       (v_orgdep_id,
                                                        NULL, au.depid,
                                                        TO_NUMBER (v_orgdep_id)
                                                       )
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND (   ar.privacylevel IS NULL
                                              OR ar.privacylevel LIKE
                                                    '%' || v_privacylevel
                                                    || '%'
                                             )
                                         AND (   ar.urgentlevel IS NULL
                                              OR ar.urgentlevel LIKE
                                                    '%' || v_urgentlevel
                                                    || '%'
                                             )
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.is_shared = 1
                                         AND archtype = v_archive_type
                                         AND pr.runstatus = 2) a
                            ORDER BY DECODE (v_search,
                                             'runSubject', subject,
                                             'archivesNo', archivesno,
                                             'depSignNo', depsignno,
                                             'issueDate', TO_CHAR
                                                      (issuedate,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             'signDate', TO_CHAR
                                                      (sign_date,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             TO_CHAR (createtime,
                                                      'YYYY-MM-DD HH24:MI:SS'
                                                     )
                                            )) b
                  ORDER BY row_count DESC;
            ELSE
               OPEN v_cursor FOR
                  SELECT   b.*,
                           DECODE (v_asc_desc,
                                   'ASC', 1000000 - ROWNUM,
                                   1000000 + ROWNUM
                                  ) AS row_count
                      FROM (SELECT   *
                                FROM (SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                             JOIN app_user au
                                             ON ar.issuerid = au.userid
                                           AND au.depid =
                                                  DECODE
                                                       (v_orgdep_id,
                                                        NULL, au.depid,
                                                        TO_NUMBER (v_orgdep_id)
                                                       )
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                                         AND ar.urgentlevel LIKE
                                                   '%' || v_urgentlevel || '%'
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND (   l_is_admin = 1
                                              OR l_is_common_admin = 1
                                              OR EXISTS (
                                                    SELECT 1
                                                      FROM process_form
                                                     WHERE runid = pr.runid
                                                       AND creatorid IN (
                                                              SELECT userid
                                                                FROM app_user
                                                               WHERE depid =
                                                                        l_depid))
                                             )
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND archtype = v_archive_type
                                         AND pr.runstatus = 2
                                      UNION
                                      SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                             JOIN app_user au
                                             ON ar.issuerid = au.userid
                                           AND au.depid =
                                                  DECODE
                                                       (v_orgdep_id,
                                                        NULL, au.depid,
                                                        TO_NUMBER (v_orgdep_id)
                                                       )
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND (   ar.privacylevel IS NULL
                                              OR ar.privacylevel LIKE
                                                    '%' || v_privacylevel
                                                    || '%'
                                             )
                                         AND (   ar.urgentlevel IS NULL
                                              OR ar.urgentlevel LIKE
                                                    '%' || v_urgentlevel
                                                    || '%'
                                             )
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.is_shared = 1
                                         AND archtype = v_archive_type
                                         AND pr.runstatus = 2) a
                            ORDER BY DECODE (v_search,
                                             'runSubject', subject,
                                             'archivesNo', archivesno,
                                             'depSignNo', depsignno,
                                             'issueDate', TO_CHAR
                                                      (issuedate,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             'signDate', TO_CHAR
                                                      (sign_date,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             TO_CHAR (createtime,
                                                      'YYYY-MM-DD HH24:MI:SS'
                                                     )
                                            )) b
                  ORDER BY row_count DESC;
            END IF;
         ELSE
            IF (    l_is_officestaff = 0
                AND l_is_officestaffadmin = 0
                AND l_is_common_admin = 0
                AND l_is_admin = 0
               )
            THEN
               OPEN v_cursor FOR
                  SELECT *
                    FROM (SELECT a.*, ROWNUM row_num
                            FROM (SELECT   b.*,
                                           DECODE (v_asc_desc,
                                                   'ASC', 1000000 - ROWNUM,
                                                   1000000 + ROWNUM
                                                  ) AS row_count
                                      FROM (SELECT   *
                                                FROM (SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND au.depid =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND ar.privacylevel LIKE
                                                                   '%'
                                                                || v_privacylevel
                                                                || '%'
                                                         AND ar.urgentlevel LIKE
                                                                   '%'
                                                                || v_urgentlevel
                                                                || '%'
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND EXISTS (
                                                                SELECT 1
                                                                  FROM process_form
                                                                 WHERE runid =
                                                                          pr.runid
                                                                   AND creatorid =
                                                                          v_userid)
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND archtype =
                                                                v_archive_type
                                                         AND pr.runstatus = 2
                                                      UNION
                                                      SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND au.depid =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND (   ar.privacylevel IS NULL
                                                              OR ar.privacylevel LIKE
                                                                       '%'
                                                                    || v_privacylevel
                                                                    || '%'
                                                             )
                                                         AND (   ar.urgentlevel IS NULL
                                                              OR ar.urgentlevel LIKE
                                                                       '%'
                                                                    || v_urgentlevel
                                                                    || '%'
                                                             )
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND ar.is_shared = 1
                                                         AND archtype =
                                                                v_archive_type
                                                         AND pr.runstatus = 2) a
                                            ORDER BY DECODE
                                                        (v_search,
                                                         'runSubject', subject,
                                                         'archivesNo', archivesno,
                                                         'depSignNo', depsignno,
                                                         'issueDate', TO_CHAR
                                                            (issuedate,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         'signDate', TO_CHAR
                                                            (sign_date,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         TO_CHAR
                                                            (createtime,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            )
                                                        )) b
                                  ORDER BY row_count DESC) a) m
                   WHERE m.row_num > l_start_index
                         AND m.row_num <= l_end_index;
            ELSE
               OPEN v_cursor FOR
                  SELECT *
                    FROM (SELECT a.*, ROWNUM row_num
                            FROM (SELECT   b.*,
                                           DECODE (v_asc_desc,
                                                   'ASC', 1000000 - ROWNUM,
                                                   1000000 + ROWNUM
                                                  ) AS row_count
                                      FROM (SELECT   *
                                                FROM (SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                              JOIN process_form pf ON pf.runid=pr.runid
                                                              JOIN app_user us ON pf.creatorid=us.userid
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND au.depid =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND ar.privacylevel LIKE
                                                                   '%'
                                                                || v_privacylevel
                                                                || '%'
                                                         AND ar.urgentlevel LIKE
                                                                   '%'
                                                                || v_urgentlevel
                                                                || '%'
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND (   l_is_admin =
                                                                             1
                                                              OR l_is_common_admin =
                                                                             1
                                                              OR us.depid = l_depid
                                                             )
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND archtype =
                                                                v_archive_type
                                                         AND pr.runstatus = 2
                                                      UNION
                                                      SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND au.depid =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND (   ar.privacylevel IS NULL
                                                              OR ar.privacylevel LIKE
                                                                       '%'
                                                                    || v_privacylevel
                                                                    || '%'
                                                             )
                                                         AND (   ar.urgentlevel IS NULL
                                                              OR ar.urgentlevel LIKE
                                                                       '%'
                                                                    || v_urgentlevel
                                                                    || '%'
                                                             )
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND ar.is_shared = 1
                                                         AND archtype =
                                                                v_archive_type
                                                         AND pr.runstatus = 2) a
                                            ORDER BY DECODE
                                                        (v_search,
                                                         'runSubject', subject,
                                                         'archivesNo', archivesno,
                                                         'depSignNo', depsignno,
                                                         'issueDate', TO_CHAR
                                                            (issuedate,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         'signDate', TO_CHAR
                                                            (sign_date,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         TO_CHAR
                                                            (createtime,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            )
                                                        )) b
                                  ORDER BY row_count DESC) a) m
                   WHERE m.row_num > l_start_index
                         AND m.row_num <= l_end_index;
            END IF;
         END IF;
      END IF;

      IF (v_archive_type = 1)
      THEN
         IF (    l_is_officestaff = 0
             AND l_is_officestaffadmin = 0
             AND l_is_admin = 0
             AND l_is_common_admin = 0
            )
         THEN
            SELECT COUNT (*)
              INTO v_count
              FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND (   (    ar.orgdep_id IS NOT NULL
                                AND ar.orgdep_id LIKE
                                                     '%' || v_orgdep_id || '%'
                               )
                            OR (ar.orgdep_id IS NULL AND v_orgdep_id IS NULL
                               )
                           )
                       AND EXISTS (
                               SELECT 1
                                 FROM process_form
                                WHERE runid = pr.runid
                                      AND creatorid = v_userid)
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND archtype IN (1, 2)
                       AND pr.runstatus = 2
                    UNION
                    SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.is_shared = 1
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2);
         ELSE
            SELECT COUNT (*)
              INTO v_count
              FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                            JOIN process_form pf ON pf.runid=pr.runid
                                                              JOIN app_user us ON pf.creatorid=us.userid
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND ar.ORGDEP_ID =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND (   (    ar.orgdep_id IS NOT NULL
                                AND ar.orgdep_id LIKE
                                                     '%' || v_orgdep_id || '%'
                               )
                            OR (ar.orgdep_id IS NULL AND v_orgdep_id IS NULL
                               )
                           )
                       AND (   l_is_admin = 1
                            OR l_is_common_admin = 1
                            OR us.depid = l_depid
                           )
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND archtype IN (1, 2)
                       AND pr.runstatus = 2
                    UNION
                    SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                           ar.issuerid, ar.issuer, ar.createtime,
                           ar.archivesno, ar.orgdep_name, ar.issuedep,
                           pd.NAME, ar.sign_date, ar.written_date,
                           ar.issuedate, ar.depsignno
                      FROM process_run pr JOIN pro_definition pd
                           ON pr.defid = pd.defid
                           JOIN archives ar ON pr.runid = ar.process_ins_id
                     WHERE pr.defid = NVL (v_defid, pr.defid)
                       AND ar.createtime >= l_start_dt
                       AND ar.createtime < l_end_dt
                       AND (   ar.privacylevel IS NULL
                            OR ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                           )
                       AND (   ar.urgentlevel IS NULL
                            OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                           )
                       AND ar.subject LIKE '%' || v_subject || '%'
                       AND ar.issuedep LIKE '%' || v_issuedep || '%'
                       AND ar.archivesno LIKE '%' || v_archive_no || '%'
                       AND (   (    ar.sn_config_id IS NOT NULL
                                AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                               )
                            OR (    ar.sn_config_id IS NULL
                                AND v_snconfig_id IS NULL
                               )
                           )
                       AND (   (    ar.depsignno IS NOT NULL
                                AND ar.depsignno LIKE
                                                    '%' || v_depsign_no || '%'
                               )
                            OR (ar.depsignno IS NULL AND v_depsign_no IS NULL
                               )
                           )
                       AND (   (    ar.issuer IS NOT NULL
                                AND ar.issuer LIKE '%' || v_issuer_name || '%'
                               )
                            OR (ar.issuer IS NULL AND v_issuer_name IS NULL)
                           )
                       AND ar.is_shared = 1
                       AND archtype = v_archive_type
                       AND pr.runstatus = 2);
         END IF;

         IF (l_is_not_page = 1)
         THEN
            IF (    l_is_officestaff = 0
                AND l_is_officestaffadmin = 0
                AND l_is_admin = 0
                AND l_is_common_admin = 0
               )
            THEN
               OPEN v_cursor FOR
                  SELECT   b.*,
                           DECODE (v_asc_desc,
                                   'ASC', 1000000 - ROWNUM,
                                   1000000 + ROWNUM
                                  ) AS row_count
                      FROM (SELECT   a.*
                                FROM (SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND (   (    ar.orgdep_id IS NOT NULL
                                                  AND ar.orgdep_id LIKE
                                                            '%'
                                                         || v_orgdep_id
                                                         || '%'
                                                 )
                                              OR (    ar.orgdep_id IS NULL
                                                  AND v_orgdep_id IS NULL
                                                 )
                                             )
                                         AND EXISTS (
                                                SELECT 1
                                                  FROM process_form
                                                 WHERE runid = pr.runid
                                                   AND creatorid = v_userid)
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND archtype IN (1, 2)
                                         AND pr.runstatus = 2
                                      UNION
                                      SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND (   ar.privacylevel IS NULL
                                              OR ar.privacylevel LIKE
                                                    '%' || v_privacylevel
                                                    || '%'
                                             )
                                         AND (   ar.urgentlevel IS NULL
                                              OR ar.urgentlevel LIKE
                                                    '%' || v_urgentlevel
                                                    || '%'
                                             )
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.is_shared = 1
                                         AND archtype IN (1, 2)
                                         AND pr.runstatus = 2) a
                            ORDER BY DECODE (v_search,
                                             'runSubject', subject,
                                             'archivesNo', archivesno,
                                             'depSignNo', depsignno,
                                             'issueDate', TO_CHAR
                                                      (issuedate,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             'writtenDate', TO_CHAR
                                                      (written_date,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             TO_CHAR (createtime,
                                                      'YYYY-MM-DD HH24:MI:SS'
                                                     )
                                            )) b
                  ORDER BY row_count DESC;
            ELSE
               OPEN v_cursor FOR
                  SELECT   b.*,
                           DECODE (v_asc_desc,
                                   'ASC', 1000000 - ROWNUM,
                                   1000000 + ROWNUM
                                  ) AS row_count
                      FROM (SELECT   a.*
                                FROM (SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND (   (    ar.orgdep_id IS NOT NULL
                                                  AND ar.orgdep_id LIKE
                                                            '%'
                                                         || v_orgdep_id
                                                         || '%'
                                                 )
                                              OR (    ar.orgdep_id IS NULL
                                                  AND v_orgdep_id IS NULL
                                                 )
                                             )
                                         AND (   l_is_admin = 1
                                              OR l_is_common_admin = 1
                                              OR EXISTS (
                                                    SELECT 1
                                                      FROM process_form
                                                     WHERE runid = pr.runid
                                                       AND creatorid IN (
                                                              SELECT userid
                                                                FROM app_user
                                                               WHERE depid =
                                                                        l_depid))
                                             )
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND archtype IN (1, 2)
                                         AND pr.runstatus = 2
                                      UNION
                                      SELECT pr.defid, pr.runid, ar.subject,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND (   ar.privacylevel IS NULL
                                              OR ar.privacylevel LIKE
                                                    '%' || v_privacylevel
                                                    || '%'
                                             )
                                         AND (   ar.urgentlevel IS NULL
                                              OR ar.urgentlevel LIKE
                                                    '%' || v_urgentlevel
                                                    || '%'
                                             )
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                  AND ar.sn_config_id =
                                                         NVL (v_snconfig_id,
                                                              ar.sn_config_id
                                                             )
                                                 )
                                              OR (    ar.sn_config_id IS NULL
                                                  AND v_snconfig_id IS NULL
                                                 )
                                             )
                                         AND (   (    ar.depsignno IS NOT NULL
                                                  AND ar.depsignno LIKE
                                                            '%'
                                                         || v_depsign_no
                                                         || '%'
                                                 )
                                              OR (    ar.depsignno IS NULL
                                                  AND v_depsign_no IS NULL
                                                 )
                                             )
                                         AND (   (    ar.issuer IS NOT NULL
                                                  AND ar.issuer LIKE
                                                            '%'
                                                         || v_issuer_name
                                                         || '%'
                                                 )
                                              OR (    ar.issuer IS NULL
                                                  AND v_issuer_name IS NULL
                                                 )
                                             )
                                         AND ar.is_shared = 1
                                         AND archtype IN (1, 2)
                                         AND pr.runstatus = 2) a
                            ORDER BY DECODE (v_search,
                                             'runSubject', subject,
                                             'archivesNo', archivesno,
                                             'depSignNo', depsignno,
                                             'issueDate', TO_CHAR
                                                      (issuedate,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             'writtenDate', TO_CHAR
                                                      (written_date,
                                                       'YYYY-MM-DD HH24:MI:SS'
                                                      ),
                                             TO_CHAR (createtime,
                                                      'YYYY-MM-DD HH24:MI:SS'
                                                     )
                                            )) b
                  ORDER BY row_count DESC;
            END IF;
         ELSE
            IF (    l_is_officestaff = 0
                AND l_is_officestaffadmin = 0
                AND l_is_admin = 0
               )
            THEN
               OPEN v_cursor FOR
                  SELECT *
                    FROM (SELECT a.*, ROWNUM row_num
                            FROM (SELECT   b.*,
                                           DECODE (v_asc_desc,
                                                   'ASC', 1000000 - ROWNUM,
                                                   1000000 + ROWNUM
                                                  ) AS row_count
                                      FROM (SELECT   *
                                                FROM (SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND (   (    ar.orgdep_id IS NOT NULL
                                                                  AND ar.orgdep_id LIKE
                                                                            '%'
                                                                         || v_orgdep_id
                                                                         || '%'
                                                                 )
                                                              OR (    ar.orgdep_id IS NULL
                                                                  AND v_orgdep_id IS NULL
                                                                 )
                                                             )
                                                         AND EXISTS (
                                                                SELECT 1
                                                                  FROM process_form
                                                                 WHERE runid =
                                                                          pr.runid
                                                                   AND creatorid =
                                                                          v_userid)
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND archtype IN
                                                                       (1, 2)
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND pr.runstatus = 2
                                                      UNION
                                                      SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND (   ar.privacylevel IS NULL
                                                              OR ar.privacylevel LIKE
                                                                       '%'
                                                                    || v_privacylevel
                                                                    || '%'
                                                             )
                                                         AND (   ar.urgentlevel IS NULL
                                                              OR ar.urgentlevel LIKE
                                                                       '%'
                                                                    || v_urgentlevel
                                                                    || '%'
                                                             )
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND ar.is_shared = 1
                                                         AND archtype IN
                                                                       (1, 2)
                                                         AND pr.runstatus = 2) a
                                            ORDER BY DECODE
                                                        (v_search,
                                                         'runSubject', subject,
                                                         'archivesNo', archivesno,
                                                         'depSignNo', depsignno,
                                                         'issueDate', TO_CHAR
                                                            (issuedate,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         'writtenDate', TO_CHAR
                                                            (written_date,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         TO_CHAR
                                                            (createtime,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            )
                                                        )) b
                                  ORDER BY row_count DESC) a) m
                   WHERE m.row_num > l_start_index
                         AND m.row_num <= l_end_index;
            ELSE
               OPEN v_cursor FOR
                  SELECT *
                    FROM (SELECT a.*, ROWNUM row_num
                            FROM (SELECT   b.*,
                                           DECODE (v_asc_desc,
                                                   'ASC', 1000000 - ROWNUM,
                                                   1000000 + ROWNUM
                                                  ) AS row_count
                                      FROM (SELECT   *
                                                FROM (SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                                JOIN process_form pf ON pf.runid=pr.runid
                                                              JOIN app_user us ON pf.creatorid=us.userid
                                                             JOIN app_user au
                                                             ON ar.issuerid =
                                                                     au.userid
                                                           AND ar.ORGDEP_ID =
                                                                  DECODE
                                                                     (v_orgdep_id,
                                                                      NULL, au.depid,
                                                                      TO_NUMBER
                                                                         (v_orgdep_id
                                                                         )
                                                                     )
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND (   (    ar.orgdep_id IS NOT NULL
                                                                  AND ar.orgdep_id LIKE
                                                                            '%'
                                                                         || v_orgdep_id
                                                                         || '%'
                                                                 )
                                                              OR (    ar.orgdep_id IS NULL
                                                                  AND v_orgdep_id IS NULL
                                                                 )
                                                             )
                                                         AND (   l_is_admin =
                                                                             1
                                                              OR l_is_common_admin =
                                                                             1
                                                              OR us.depid =  l_depid
                                                             )
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND archtype IN
                                                                       (1, 2)
                                                         AND pr.runstatus = 2
                                                      UNION
                                                      SELECT pr.defid,
                                                             pr.runid,
                                                             ar.subject,
                                                             ar.archivesid,
                                                             ar.issuerid,
                                                             ar.issuer,
                                                             ar.createtime,
                                                             ar.archivesno,
                                                             ar.orgdep_name,
                                                             ar.issuedep,
                                                             pd.NAME,
                                                             ar.sign_date,
                                                             ar.written_date,
                                                             ar.issuedate,
                                                             ar.depsignno
                                                        FROM process_run pr JOIN pro_definition pd
                                                             ON pr.defid =
                                                                      pd.defid
                                                             JOIN archives ar
                                                             ON pr.runid =
                                                                  ar.process_ins_id
                                                       WHERE pr.defid =
                                                                NVL (v_defid,
                                                                     pr.defid
                                                                    )
                                                         AND ar.createtime >=
                                                                    l_start_dt
                                                         AND ar.createtime <
                                                                      l_end_dt
                                                         AND (   ar.privacylevel IS NULL
                                                              OR ar.privacylevel LIKE
                                                                       '%'
                                                                    || v_privacylevel
                                                                    || '%'
                                                             )
                                                         AND (   ar.urgentlevel IS NULL
                                                              OR ar.urgentlevel LIKE
                                                                       '%'
                                                                    || v_urgentlevel
                                                                    || '%'
                                                             )
                                                         AND ar.subject LIKE
                                                                   '%'
                                                                || v_subject
                                                                || '%'
                                                         AND ar.issuedep LIKE
                                                                   '%'
                                                                || v_issuedep
                                                                || '%'
                                                         AND ar.archivesno LIKE
                                                                   '%'
                                                                || v_archive_no
                                                                || '%'
                                                         AND (   (    ar.sn_config_id IS NOT NULL
                                                                  AND ar.sn_config_id =
                                                                         NVL
                                                                            (v_snconfig_id,
                                                                             ar.sn_config_id
                                                                            )
                                                                 )
                                                              OR (    ar.sn_config_id IS NULL
                                                                  AND v_snconfig_id IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.depsignno IS NOT NULL
                                                                  AND ar.depsignno LIKE
                                                                            '%'
                                                                         || v_depsign_no
                                                                         || '%'
                                                                 )
                                                              OR (    ar.depsignno IS NULL
                                                                  AND v_depsign_no IS NULL
                                                                 )
                                                             )
                                                         AND (   (    ar.issuer IS NOT NULL
                                                                  AND ar.issuer LIKE
                                                                            '%'
                                                                         || v_issuer_name
                                                                         || '%'
                                                                 )
                                                              OR (    ar.issuer IS NULL
                                                                  AND v_issuer_name IS NULL
                                                                 )
                                                             )
                                                         AND ar.is_shared = 1
                                                         AND archtype IN
                                                                       (1, 2)
                                                         AND pr.runstatus = 2) a
                                            ORDER BY DECODE
                                                        (v_search,
                                                         'runSubject', subject,
                                                         'archivesNo', archivesno,
                                                         'depSignNo', depsignno,
                                                         'issueDate', TO_CHAR
                                                            (issuedate,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         'writtenDate', TO_CHAR
                                                            (written_date,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            ),
                                                         TO_CHAR
                                                            (createtime,
                                                             'YYYY-MM-DD HH24:MI:SS'
                                                            )
                                                        )) b
                                  ORDER BY row_count DESC) a) m
                   WHERE m.row_num > l_start_index
                         AND m.row_num <= l_end_index;
            END IF;
         END IF;
      END IF;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         NULL;
      WHEN OTHERS
      THEN
         -- Consider logging the error and then re-raise
         RAISE;
   END;

   PROCEDURE get_archives_isstandard (
      v_archive_type   IN       INTEGER,
      v_subject        IN       VARCHAR2,
      v_defid          IN       NUMBER,
      v_issuedep       IN       VARCHAR2,
      v_orgdep_id      IN       VARCHAR2,
      v_start_dt       IN       VARCHAR2,
      v_end_dt         IN       VARCHAR2,
      v_archive_no     IN       VARCHAR2,
      v_privacylevel   IN       VARCHAR2,
      v_urgentlevel    IN       VARCHAR2,
      v_snconfig_id    IN       NUMBER,
      v_start_page     IN       INTEGER,
      v_page_size      IN       INTEGER,
      v_count          OUT      INTEGER,
      v_cursor         OUT      sys_refcursor
   )
   IS
      l_start_dt              DATE;
      l_end_dt                DATE;
      l_start_index           INTEGER;
      l_end_index             INTEGER;
      l_count                 INTEGER;
      l_is_not_page           INTEGER := 0;
      l_is_admin              INTEGER := 0;
      l_is_officestaff        INTEGER := 0;
      l_is_officestaffadmin   INTEGER := 0;
      l_depid                 NUMBER;
      l_roleid                NUMBER;
   BEGIN
      IF (v_start_dt IS NULL OR v_start_dt = '')
      THEN
         l_start_dt := TO_DATE ('1900-01-01', 'YYYY-MM-DD');
      ELSE
         l_start_dt := TO_DATE (v_start_dt, 'YYYY-MM-DD');
      END IF;

      IF (v_end_dt IS NULL OR v_end_dt = '')
      THEN
         l_end_dt := TRUNC (ADD_MONTHS (SYSDATE, 12) + 1);
      --TRUNC (SYSDATE + 1);
      ELSE
         l_end_dt := TRUNC (TO_DATE (v_end_dt, 'YYYY-MM-DD') + 1);
      END IF;

      IF (v_page_size IS NULL OR v_page_size = -1)
      THEN
         l_is_not_page := 1;
      ELSE
         l_start_index := NVL (v_start_page, 0);
         l_end_index := l_start_index + v_page_size;
      END IF;

      SELECT COUNT (*)
        INTO v_count
        FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                     ar.standard_approver, ar.standard_approve_date,
                     ar.issuerid, ar.issuer, ar.createtime, ar.archivesno,
                     ar.orgdep_name, ar.issuedep, pd.NAME, ar.sign_date,
                     ar.written_date, ar.issuedate, ar.depsignno, au.fullname
                FROM process_run pr JOIN pro_definition pd ON pr.defid =
                                                                      pd.defid
                     JOIN archives ar ON pr.runid = ar.process_ins_id
                     LEFT JOIN app_user au ON ar.standard_approver = au.userid
               WHERE pr.defid = NVL (v_defid, pr.defid)
                 AND ar.createtime >= l_start_dt
                 AND ar.createtime < l_end_dt
                 AND ar.is_standard = 1
                 AND (   ar.privacylevel IS NULL
                      OR ar.privacylevel LIKE '%' || v_privacylevel || '%'
                     )
                 AND (   ar.urgentlevel IS NULL
                      OR ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                     )
                 AND ar.subject LIKE '%' || v_subject || '%'
                 AND ar.issuedep LIKE '%' || v_issuedep || '%'
                 AND ar.archivesno LIKE '%' || v_archive_no || '%'
                 AND ar.sn_config_id = NVL (v_snconfig_id, ar.sn_config_id)
                 AND archtype = v_archive_type
                 AND pr.runstatus = 2);

      IF (l_is_not_page = 1)
      THEN
         OPEN v_cursor FOR
            SELECT   *
                FROM (SELECT pr.defid, pr.runid, ar.subject, ar.archivesid,
                             ar.standard_approver, ar.standard_approve_date,
                             ar.issuerid, ar.issuer, ar.createtime,
                             ar.archivesno, ar.orgdep_name, ar.issuedep,
                             pd.NAME, ar.sign_date, ar.written_date,
                             ar.issuedate, ar.depsignno, au.fullname
                        FROM process_run pr JOIN pro_definition pd
                             ON pr.defid = pd.defid
                             JOIN archives ar ON pr.runid = ar.process_ins_id
                             LEFT JOIN app_user au
                             ON ar.standard_approver = au.userid
                       WHERE pr.defid = NVL (v_defid, pr.defid)
                         AND ar.createtime >= l_start_dt
                         AND ar.createtime < l_end_dt
                         AND ar.is_standard = 1
                         AND ar.privacylevel LIKE '%' || v_privacylevel || '%'
                         AND ar.urgentlevel LIKE '%' || v_urgentlevel || '%'
                         AND ar.subject LIKE '%' || v_subject || '%'
                         AND ar.issuedep LIKE '%' || v_issuedep || '%'
                         AND EXISTS (SELECT 1
                                       FROM process_form
                                      WHERE runid = pr.runid)
                         AND ar.archivesno LIKE '%' || v_archive_no || '%'
                         AND ar.sn_config_id =
                                          NVL (v_snconfig_id, ar.sn_config_id)
                         AND archtype = v_archive_type
                         AND pr.runstatus = 2) a
            ORDER BY createtime DESC;
      ELSE
         OPEN v_cursor FOR
            SELECT *
              FROM (SELECT a.*, ROWNUM row_num
                      FROM (SELECT   *
                                FROM (SELECT pr.defid, pr.runid, ar.subject,
                                             ar.standard_approver,
                                             ar.standard_approve_date,
                                             ar.archivesid, ar.issuerid,
                                             ar.issuer, ar.createtime,
                                             ar.archivesno, ar.orgdep_name,
                                             ar.issuedep, pd.NAME,
                                             ar.sign_date, ar.written_date,
                                             ar.issuedate, ar.depsignno,
                                             au.fullname
                                        FROM process_run pr JOIN pro_definition pd
                                             ON pr.defid = pd.defid
                                             JOIN archives ar
                                             ON pr.runid = ar.process_ins_id
                                             LEFT JOIN app_user au
                                             ON ar.standard_approver =
                                                                     au.userid
                                       WHERE pr.defid =
                                                       NVL (v_defid, pr.defid)
                                         AND ar.createtime >= l_start_dt
                                         AND ar.createtime < l_end_dt
                                         AND ar.is_standard = 1
                                         AND ar.privacylevel LIKE
                                                  '%' || v_privacylevel || '%'
                                         AND ar.urgentlevel LIKE
                                                   '%' || v_urgentlevel || '%'
                                         AND ar.subject LIKE
                                                       '%' || v_subject || '%'
                                         AND ar.issuedep LIKE
                                                      '%' || v_issuedep || '%'
                                         AND EXISTS (SELECT 1
                                                       FROM process_form
                                                      WHERE runid = pr.runid)
                                         AND ar.archivesno LIKE
                                                    '%' || v_archive_no || '%'
                                         AND ar.sn_config_id =
                                                NVL (v_snconfig_id,
                                                     ar.sn_config_id
                                                    )
                                         AND archtype = v_archive_type
                                         AND pr.runstatus = 2) a
                            ORDER BY createtime DESC) a) m
             WHERE m.row_num > l_start_index AND m.row_num <= l_end_index;
      END IF;
   EXCEPTION
      WHEN NO_DATA_FOUND
      THEN
         NULL;
      WHEN OTHERS
      THEN
         -- Consider logging the error and then re-raise
         RAISE;
   END;
END archives_manage_pg; 
